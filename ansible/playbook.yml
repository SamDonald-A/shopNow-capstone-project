---
- name: Install DevOps tools on Ubuntu EC2
  hosts: Ubuntu_Servers
  become: yes
  gather_facts: yes

  vars:
    apt_packages:
      - docker.io
      - unzip
      - curl
      - ca-certificates
      - gnupg
      - lsb-release

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install base apt packages
      apt:
        name: "{{ apt_packages }}"
        state: present

    - name: Start and enable Docker
      service:
        name: docker
        state: started
        enabled: yes

    # ---------------- kubectl ----------------
    - name: Get latest kubectl version
      shell: curl -Ls https://dl.k8s.io/release/stable.txt
      register: kubectl_version
      changed_when: false

    - name: Install kubectl
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version.stdout }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    # ---------------- AWS CLI ----------------
    - name: Download AWS CLI v2
      get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip

    - name: Unzip AWS CLI
      unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp
        remote_src: yes

    - name: Install AWS CLI
      command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws

    # ---------------- eksctl ----------------
    - name: Download eksctl
      get_url:
        url: https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_Linux_amd64.tar.gz
        dest: /tmp/eksctl.tar.gz

    - name: Install eksctl
      unarchive:
        src: /tmp/eksctl.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        mode: '0755'

    # ---------------- Helm ----------------
    - name: Install Helm
      shell: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    # ---------------- Terraform ----------------
    - name: Add HashiCorp GPG key
      shell: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | \
        gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg

    - name: Add HashiCorp repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present

    - name: Install Terraform
      apt:
        name: terraform
        state: present
